blueprint:
  name: IKEA BILRESA (Matter) Dual Button â†’ 2 Lights + Adaptive per Light + Tap Toggle + Long Hold (Release) Mode Toggle (No Helpers)
  description: >
    - Tap: toggle light on/off
    - Hold: no action while holding
    - Release after hold:
        * only if held >= threshold (0.25s steps)
        * only if light is ON
        * toggles Adaptive <-> White mode for that light
    No helpers required. Avoids !input inside templates by staging inputs as plain variables first.
  domain: automation

  input:
    button1_event:
      name: Button 1 event entity (Matter)
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button

    button2_event:
      name: Button 2 event entity (Matter)
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button

    light_1:
      name: Light 1 (Button 1)
      selector:
        entity:
          filter:
            domain: light

    light_2:
      name: Light 2 (Button 2)
      selector:
        entity:
          filter:
            domain: light

    adaptive_switch_1:
      name: Adaptive Lighting switch for Light 1 (recommended)
      description: "e.g. switch.adaptive_lighting_<instance_for_light_1>"
      default: ""
      selector:
        entity:
          filter:
            domain: switch

    adaptive_switch_2:
      name: Adaptive Lighting switch for Light 2 (recommended)
      description: "e.g. switch.adaptive_lighting_<instance_for_light_2>"
      default: ""
      selector:
        entity:
          filter:
            domain: switch

    full_white_kelvin:
      name: White mode color temperature (K)
      default: 6500
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider

    full_white_brightness_pct:
      name: White mode brightness (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    hold_threshold_1:
      name: Button 1 hold threshold (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider

    hold_threshold_2:
      name: Button 2 hold threshold (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider

    # If your event_type strings differ, set them here instead of editing the YAML logic
    tap_event_type:
      name: Tap event_type
      default: multi_press_1
      selector:
        text: {}
    hold_event_type:
      name: Hold (start) event_type
      default: long_press
      selector:
        text: {}
    release_event_type:
      name: Release (after hold) event_type
      default: long_release
      selector:
        text: {}

mode: restart

trigger:
  - platform: state
    id: b1
    entity_id: !input button1_event
  - platform: state
    id: b2
    entity_id: !input button2_event

condition:
  - condition: template
    value_template: >
      {{ trigger.from_state is not none and trigger.to_state is not none
         and trigger.from_state.state not in ['unknown','unavailable']
         and trigger.to_state.state not in ['unknown','unavailable']
         and trigger.from_state.state != trigger.to_state.state }}

variables:
  # ---- Stage blueprint inputs as plain YAML values (NO Jinja here) ----
  light1: !input light_1
  light2: !input light_2
  adaptive1: !input adaptive_switch_1
  adaptive2: !input adaptive_switch_2
  threshold1: !input hold_threshold_1
  threshold2: !input hold_threshold_2
  kelvin: !input full_white_kelvin
  bright: !input full_white_brightness_pct
  tap_type: !input tap_event_type
  hold_type: !input hold_event_type
  release_type: !input release_event_type

  # ---- Derived variables (Jinja OK) ----
  press_type: "{{ trigger.to_state.attributes.event_type }}"
  is_b1: "{{ trigger.id == 'b1' }}"
  event_entity: "{{ trigger.entity_id }}"
  target_light: "{{ light1 if is_b1 else light2 }}"
  target_adaptive: "{{ adaptive1 if is_b1 else adaptive2 }}"
  hold_threshold: "{{ threshold1 if is_b1 else threshold2 }}"

action:
  - choose:
      # ---------------------------
      # TAP -> toggle on/off
      # ---------------------------
      - conditions:
          - condition: template
            value_template: "{{ press_type == tap_type }}"
        sequence:
          - action: light.toggle
            target:
              entity_id: "{{ target_light }}"

      # ---------------------------
      # HOLD START -> decide if this becomes a "long hold"
      # We only act on RELEASE, and only if held >= threshold.
      # ---------------------------
      - conditions:
          - condition: template
            value_template: "{{ press_type == hold_type }}"
        sequence:
          # 1) If release happens BEFORE threshold => short hold => do nothing
          - wait_template: >
              {{ state_attr(event_entity, 'event_type') == release_type }}
            timeout:
              seconds: "{{ hold_threshold }}"
            continue_on_timeout: true

          # If wait_template completed, we saw release before threshold -> exit.
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not wait.completed }}"
                sequence:
                  # 2) We timed out => long hold. Now wait for actual release, then toggle mode.
                  - wait_template: >
                      {{ state_attr(event_entity, 'event_type') == release_type }}
                    timeout:
                      minutes: 10
                    continue_on_timeout: false

                  # Only toggle mode if light is ON
                  - condition: template
                    value_template: "{{ is_state(target_light, 'on') }}"

                  # Toggle mode based on adaptive switch state
                  - choose:
                      # Adaptive ON -> White mode (turn adaptive OFF + force white)
                      - conditions:
                          - condition: template
                            value_template: "{{ target_adaptive != '' and is_state(target_adaptive, 'on') }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: "{{ target_adaptive }}"
                          - action: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: "{{ bright }}"
                              color_temp_kelvin: "{{ kelvin }}"

                      # Adaptive OFF -> Adaptive ON (return to adaptive)
                      - conditions:
                          - condition: template
                            value_template: "{{ target_adaptive != '' and is_state(target_adaptive, 'off') }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: "{{ target_adaptive }}"
                          # Optional nudge so adaptive takes over immediately
                          - delay:
                              milliseconds: 150
                          - action: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data: {}
                    default:
                      # If no adaptive switch is configured, best-effort "white" only
                      - action: light.turn_on
                        target:
                          entity_id: "{{ target_light }}"
                        data:
                          brightness_pct: "{{ bright }}"
                          color_temp_kelvin: "{{ kelvin }}"
            default: []
    default: []
