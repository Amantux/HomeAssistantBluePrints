blueprint:
  name: IKEA BILRESA (Matter) Dual Button → 2 Lights (Option A: Turn On then Adaptive Apply) + Long-Press Full White Toggle
  description: >
    Option A to reduce flicker: on single-press ON, turn the light on without attributes first,
    then apply Adaptive Lighting (optionally after a small delay). Long press toggles full white ↔ adaptive.
    Designed for IKEA BILRESA dual-button Matter remote (IKEA 806.178.76).
  domain: automation

  input:
    button1_event:
      name: Button 1 event entity
      description: Matter event entity for Button 1
      selector:
        entity:
          multiple: false
          filter:
            integration: matter
            domain: event
            device_class: button

    button2_event:
      name: Button 2 event entity
      description: Matter event entity for Button 2
      selector:
        entity:
          multiple: false
          filter:
            integration: matter
            domain: event
            device_class: button

    light_a:
      name: Light A (Button 1)
      selector:
        entity:
          domain: light

    light_b:
      name: Light B (Button 2)
      selector:
        entity:
          domain: light

    adaptive_switch:
      name: Adaptive Lighting switch
      description: Must be the Adaptive Lighting instance that manages these lights (switch.adaptive_lighting_*)
      selector:
        entity:
          multiple: false
          filter:
            integration: adaptive_lighting
            domain: switch

    apply_transition:
      name: Adaptive apply transition (seconds)
      description: Small transition helps settle to adaptive values without visible stepping
      default: 0.1
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: s

    apply_delay_ms:
      name: Delay before adaptive apply (ms)
      description: Tiny delay can help bulbs that power on at a default/last state before accepting attribute updates
      default: 150
      selector:
        number:
          min: 0
          max: 1000
          step: 50
          unit_of_measurement: ms

    full_white_kelvin:
      name: Full power white Kelvin (long press)
      default: 4000
      selector:
        number:
          min: 2700
          max: 6500
          step: 100
          unit_of_measurement: K

mode: restart

trigger:
  - platform: state
    id: button1
    entity_id: !input button1_event
  - platform: state
    id: button2
    entity_id: !input button2_event

# “No flicker” guard pattern: ignore unknown/unavailable and only act on real state changes
condition:
  - condition: template
    value_template: "{{ trigger.from_state is not none and trigger.to_state is not none }}"
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  - condition: template
    value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
  - condition: template
    value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"

variables:
  adaptive: !input adaptive_switch
  tr: !input apply_transition
  delay_ms: !input apply_delay_ms
  kelvin: !input full_white_kelvin

  trigger_id: "{{ trigger.id }}"
  press_type: "{{ trigger.to_state.attributes.event_type | default('') }}"

  # Event mapping (matches common Matter BILRESA patterns)
  single_press_type: "multi_press_1"
  long_press_type: "long_press"

  # Full-white detection thresholds
  full_white_bri_min: 250
  full_white_kelvin_tol: 250

action:
  - choose:

      # ───────── Button 1: SINGLE PRESS → toggle Light A (Option A turn-on flow) ─────────
      - conditions: "{{ trigger_id == 'button1' and press_type == single_press_type }}"
        sequence:
          - variables:
              L: !input light_a
          - choose:
              - conditions: "{{ is_state(L, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ L }}"
            default:
              # Turn on first WITHOUT brightness/CT so the bulb comes up “normally”
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"

              # Ensure Adaptive Lighting owns it
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: false

              # Optional tiny delay, then apply current adaptive settings (do NOT turn_on via apply)
              - choose:
                  - conditions: "{{ (delay_ms | int) > 0 }}"
                    sequence:
                      - delay:
                          milliseconds: "{{ delay_ms | int }}"
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  transition: "{{ tr | float }}"

      # ───────── Button 2: SINGLE PRESS → toggle Light B (Option A turn-on flow) ─────────
      - conditions: "{{ trigger_id == 'button2' and press_type == single_press_type }}"
        sequence:
          - variables:
              L: !input light_b
          - choose:
              - conditions: "{{ is_state(L, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ L }}"
            default:
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: false
              - choose:
                  - conditions: "{{ (delay_ms | int) > 0 }}"
                    sequence:
                      - delay:
                          milliseconds: "{{ delay_ms | int }}"
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  transition: "{{ tr | float }}"

      # ───────── Button 1: LONG PRESS → toggle Full White ↔ Adaptive (Light A) ─────────
      - conditions: "{{ trigger_id == 'button1' and press_type == long_press_type }}"
        sequence:
          - variables:
              L: !input light_a
              bri: "{{ state_attr(L, 'brightness') | int(0) }}"
              ct: "{{ state_attr(L, 'color_temp_kelvin') | int(0) }}"
              is_full_white_now: >
                {{ is_state(L,'on')
                   and bri >= full_white_bri_min
                   and ct != 0
                   and ((ct - (kelvin | int)) | abs) <= full_white_kelvin_tol }}
          - choose:
              # If already full white -> restore Adaptive Lighting (keep on)
              - conditions: "{{ is_full_white_now }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      manual_control: false
                  - service: adaptive_lighting.apply
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      transition: "{{ tr | float }}"
            default:
              # Otherwise -> force full white and mark manual control
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"
                data:
                  brightness: 255
                  color_temp_kelvin: "{{ kelvin | int }}"

      # ───────── Button 2: LONG PRESS → toggle Full White ↔ Adaptive (Light B) ─────────
      - conditions: "{{ trigger_id == 'button2' and press_type == long_press_type }}"
        sequence:
          - variables:
              L: !input light_b
              bri: "{{ state_attr(L, 'brightness') | int(0) }}"
              ct: "{{ state_attr(L, 'color_temp_kelvin') | int(0) }}"
              is_full_white_now: >
                {{ is_state(L,'on')
                   and bri >= full_white_bri_min
                   and ct != 0
                   and ((ct - (kelvin | int)) | abs) <= full_white_kelvin_tol }}
          - choose:
              - conditions: "{{ is_full_white_now }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      manual_control: false
                  - service: adaptive_lighting.apply
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      transition: "{{ tr | float }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"
                data:
                  brightness: 255
                  color_temp_kelvin: "{{ kelvin | int }}"
