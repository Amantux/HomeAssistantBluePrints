blueprint:
  name: IKEA BILRESA (Matter) Dual Button â†’ Toggle 2 Lights (Adaptive Lighting) + 3s Hold White/Adaptive Toggle (No Flicker)
  description: >
    For IKEA BILRESA 806.178.76 (Matter over Thread). Uses two Matter event entities (one per button).
    Single press: toggle Light A/B, letting Adaptive Lighting intercept light.turn_on (reduces flicker).
    3-second hold: toggle between a selectable "white mode" and CURRENT Adaptive Lighting settings for that time.
  domain: automation

  input:
    button_a_event:
      name: Button A event entity
      description: Select the Matter event entity for button A (e.g., event.bilresa_button_1)
      selector:
        entity:
          domain: event

    button_b_event:
      name: Button B event entity
      description: Select the Matter event entity for button B (e.g., event.bilresa_button_2)
      selector:
        entity:
          domain: event

    light_a:
      name: Light A (toggled by Button A)
      selector:
        entity:
          domain: light

    light_b:
      name: Light B (toggled by Button B)
      selector:
        entity:
          domain: light

    adaptive_switch:
      name: Adaptive Lighting switch
      description: Your Adaptive Lighting switch entity (e.g., switch.adaptive_lighting_living_room)
      selector:
        entity:
          domain: switch

    hold_seconds:
      name: Hold duration seconds
      description: How long a hold must be before the white/adaptive toggle triggers
      default: 3
      selector:
        number:
          min: 1
          max: 10
          step: 1
          mode: slider

    white_temp_kelvin:
      name: White mode color temp (Kelvin)
      description: Color temperature to use for the "white mode"
      default: 3000
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider

    white_brightness_pct:
      name: White mode brightness (%)
      description: Brightness percent to use for the "white mode"
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    white_temp_tolerance_kelvin:
      name: White mode tolerance (Kelvin)
      description: If current color_temp_kelvin is within this tolerance of the white temp, it's considered "already in white mode"
      default: 150
      selector:
        number:
          min: 0
          max: 1000
          step: 25
          mode: slider

mode: restart

trigger:
  - platform: state
    entity_id: !input button_a_event
    id: button_a
    not_from:
      - unknown
      - unavailable
  - platform: state
    entity_id: !input button_b_event
    id: button_b
    not_from:
      - unknown
      - unavailable

variables:
  light_a: !input light_a
  light_b: !input light_b
  adaptive: !input adaptive_switch

  hold_seconds: !input hold_seconds
  white_temp_kelvin: !input white_temp_kelvin
  white_brightness_pct: !input white_brightness_pct
  white_temp_tolerance_kelvin: !input white_temp_tolerance_kelvin

  # Accept common "single press" types; ignore others by default.
  single_press_types:
    - press
    - pressed
    - short_press
    - short_release
    - single_press
    - multi_press_1

  # Common "hold start" types (varies by firmware/controller)
  hold_start_types:
    - long_press
    - long_press_start
    - hold
    - button_hold
    - held

  etype: "{{ state_attr(trigger.entity_id, 'event_type') | default('') }}"

action:
  - choose:
      ############################################################
      # 3s HOLD: Button A -> toggle White <-> CURRENT Adaptive (Light A)
      ############################################################
      - conditions:
          - condition: trigger
            id: button_a
          - condition: template
            value_template: "{{ etype in hold_start_types }}"
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"
          - variables:
              target_light: "{{ light_a }}"
              cur_ct: "{{ state_attr(target_light, 'color_temp_kelvin') | default(0) | int }}"
              in_white_mode: >-
                {{
                  is_state(target_light, 'on')
                  and cur_ct > 0
                  and (cur_ct - (white_temp_kelvin | int)) | abs <= (white_temp_tolerance_kelvin | int)
                }}
          - choose:
              # If currently in white mode, revert to CURRENT Adaptive settings
              - conditions: "{{ in_white_mode }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights:
                        - "{{ target_light }}"
                      manual_control: false
                  # Let Adaptive Lighting intercept and set correct values in the same turn_on
                  - service: light.turn_on
                    target:
                      entity_id: "{{ target_light }}"
            default:
              # Otherwise switch into white mode and pause Adaptive for that light
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights:
                    - "{{ target_light }}"
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ target_light }}"
                data:
                  color_temp_kelvin: "{{ white_temp_kelvin }}"
                  brightness_pct: "{{ white_brightness_pct }}"

      ############################################################
      # 3s HOLD: Button B -> toggle White <-> CURRENT Adaptive (Light B)
      ############################################################
      - conditions:
          - condition: trigger
            id: button_b
          - condition: template
            value_template: "{{ etype in hold_start_types }}"
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"
          - variables:
              target_light: "{{ light_b }}"
              cur_ct: "{{ state_attr(target_light, 'color_temp_kelvin') | default(0) | int }}"
              in_white_mode: >-
                {{
                  is_state(target_light, 'on')
                  and cur_ct > 0
                  and (cur_ct - (white_temp_kelvin | int)) | abs <= (white_temp_tolerance_kelvin | int)
                }}
          - choose:
              - conditions: "{{ in_white_mode }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights:
                        - "{{ target_light }}"
                      manual_control: false
                  - service: light.turn_on
                    target:
                      entity_id: "{{ target_light }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights:
                    - "{{ target_light }}"
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ target_light }}"
                data:
                  color_temp_kelvin: "{{ white_temp_kelvin }}"
                  brightness_pct: "{{ white_brightness_pct }}"

      ############################################################
      # SINGLE PRESS: Button A -> toggle Light A (Adaptive on ON, no apply call)
      ############################################################
      - conditions:
          - condition: trigger
            id: button_a
          - condition: template
            value_template: "{{ etype in single_press_types or etype == '' }}"
        sequence:
          - choose:
              - conditions: "{{ is_state(light_a, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light_a }}"
            default:
              # Ensure Adaptive Lighting is allowed to control this light...
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights:
                    - "{{ light_a }}"
                  manual_control: false
              # ...then just turn it on; AL intercepts the turn_on to set correct CT/brightness.
              - service: light.turn_on
                target:
                  entity_id: "{{ light_a }}"

      ############################################################
      # SINGLE PRESS: Button B -> toggle Light B (Adaptive on ON, no apply call)
      ############################################################
      - conditions:
          - condition: trigger
            id: button_b
          - condition: template
            value_template: "{{ etype in single_press_types or etype == '' }}"
        sequence:
          - choose:
              - conditions: "{{ is_state(light_b, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light_b }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights:
                    - "{{ light_b }}"
                  manual_control: false
              - service: light.turn_on
                target:
                  entity_id: "{{ light_b }}"
