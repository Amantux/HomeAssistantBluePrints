blueprint:
  name: IKEA BILRESA (Matter) Dual Button â†’ 2 Lights + Hold/Release White Mode Toggle
  description: >
    Press once toggles light on/off.
    Long press toggles white mode after an adjustable delay (0.25s steps).
    Long release toggles white mode only if hold-delay toggle did not already fire.
  domain: automation

  input:
    button1_event:
      name: Button 1 event entity
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button
    button2_event:
      name: Button 2 event entity
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button

    light_1:
      name: Light for Button 1
      selector:
        entity:
          filter:
            domain: light
    light_2:
      name: Light for Button 2
      selector:
        entity:
          filter:
            domain: light

    # "White mode" is usually "Adaptive Lighting OFF" + force a white scene.
    adaptive_switch_1:
      name: Adaptive switch for Light 1 (optional, recommended for true "toggle white mode")
      default: ""
      selector:
        entity:
          filter:
            domain: switch
    adaptive_switch_2:
      name: Adaptive switch for Light 2 (optional, recommended for true "toggle white mode")
      default: ""
      selector:
        entity:
          filter:
            domain: switch

    full_white_kelvin:
      name: Full white color temp (K)
      default: 6500
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider
    full_white_brightness_pct:
      name: Full white brightness (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    hold_delay_seconds_1:
      name: Button 1 hold delay (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider
    hold_delay_seconds_2:
      name: Button 2 hold delay (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider

    b1_hold_consumed:
      name: Helper toggle (input_boolean) for Button 1 (prevents double-toggle)
      description: Create an input_boolean like input_boolean.bilresa_b1_hold_consumed
      selector:
        entity:
          filter:
            domain: input_boolean
    b2_hold_consumed:
      name: Helper toggle (input_boolean) for Button 2 (prevents double-toggle)
      description: Create an input_boolean like input_boolean.bilresa_b2_hold_consumed
      selector:
        entity:
          filter:
            domain: input_boolean

mode: restart

trigger:
  - platform: state
    id: b1
    entity_id: !input button1_event
  - platform: state
    id: b2
    entity_id: !input button2_event

condition:
  - condition: template
    value_template: >
      {{ trigger.from_state is not none and trigger.to_state is not none
         and trigger.from_state.state != trigger.to_state.state }}

variables:
  press_type: "{{ trigger.to_state.attributes.event_type }}"
  is_b1: "{{ trigger.id == 'b1' }}"
  light_entity: "{{ iif(is_b1, (!input light_1), (!input light_2)) }}"
  adaptive_entity: "{{ iif(is_b1, (!input adaptive_switch_1), (!input adaptive_switch_2)) }}"
  hold_delay: "{{ iif(is_b1, (!input hold_delay_seconds_1), (!input hold_delay_seconds_2)) }}"
  hold_consumed: "{{ iif(is_b1, (!input b1_hold_consumed), (!input b2_hold_consumed)) }}"
  kelvin: !input full_white_kelvin
  bright: !input full_white_brightness_pct

action:
  - choose:
      # --- Pressed once: toggle the light ON/OFF ---
      - conditions:
          - condition: template
            value_template: "{{ press_type == 'multi_press_1' }}"
        sequence:
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ hold_consumed }}"
          - action: light.toggle
            target:
              entity_id: "{{ light_entity }}"

      # --- Held down: after delay, if still holding, toggle white mode ONCE ---
      - conditions:
          - condition: template
            value_template: "{{ press_type == 'long_press' }}"
        sequence:
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ hold_consumed }}"
          - delay:
              seconds: "{{ hold_delay }}"
          # still holding = event entity hasn't changed since long_press fired
          - condition: template
            value_template: "{{ states(trigger.entity_id) == trigger.to_state.state }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_state(hold_consumed, 'off') }}"
                sequence:
                  - action: input_boolean.turn_on
                    target:
                      entity_id: "{{ hold_consumed }}"
                  - choose:
                      # If you gave an adaptive switch, "toggle white mode" = toggle adaptive on/off
                      - conditions:
                          - condition: template
                            value_template: "{{ adaptive_entity != '' and is_state(adaptive_entity, 'on') }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: "{{ adaptive_entity }}"
                          - action: light.turn_on
                            target:
                              entity_id: "{{ light_entity }}"
                            data:
                              brightness_pct: "{{ bright }}"
                              color_temp_kelvin: "{{ kelvin }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ adaptive_entity != '' and is_state(adaptive_entity, 'off') }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: "{{ adaptive_entity }}"
                    default:
                      # No adaptive switch provided: best-effort "white mode" = set full white
                      - action: light.turn_on
                        target:
                          entity_id: "{{ light_entity }}"
                        data:
                          brightness_pct: "{{ bright }}"
                          color_temp_kelvin: "{{ kelvin }}"

      # --- Released after held: toggle white mode ONLY if hold-delay toggle did not already run ---
      - conditions:
          - condition: template
            value_template: "{{ press_type == 'long_release' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_state(hold_consumed, 'off') }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ adaptive_entity != '' and is_state(adaptive_entity, 'on') }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: "{{ adaptive_entity }}"
                          - action: light.turn_on
                            target:
                              entity_id: "{{ light_entity }}"
                            data:
                              brightness_pct: "{{ bright }}"
                              color_temp_kelvin: "{{ kelvin }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ adaptive_entity != '' and is_state(adaptive_entity, 'off') }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: "{{ adaptive_entity }}"
                    default:
                      - action: light.turn_on
                        target:
                          entity_id: "{{ light_entity }}"
                        data:
                          brightness_pct: "{{ bright }}"
                          color_temp_kelvin: "{{ kelvin }}"
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ hold_consumed }}"
