blueprint:
  name: IKEA BILRESA (Matter) Dual Button → 2 Lights (Adaptive) + Long-Press Full White Toggle
  description: >
    For IKEA BILRESA dual-button remote (Matter).
    - Button 1 single press: toggle Light A (ON uses Adaptive Lighting)
    - Button 2 single press: toggle Light B (ON uses Adaptive Lighting)
    - Long press (~3s): toggle Full Power White ↔ Adaptive Lighting per light
    Uses the same no-flash trigger guard pattern as the community BILRESA blueprint.
  domain: automation

  input:
    button1_event:
      name: Button 1 event entity
      description: Matter event entity for Button 1 (event.* with device_class button)
      selector:
        entity:
          multiple: true
          filter:
            integration: matter
            domain: event
            device_class: button

    button2_event:
      name: Button 2 event entity
      description: Matter event entity for Button 2 (event.* with device_class button)
      selector:
        entity:
          multiple: true
          filter:
            integration: matter
            domain: event
            device_class: button

    light_a:
      name: Light A (Button 1)
      selector:
        entity:
          domain: light

    light_b:
      name: Light B (Button 2)
      selector:
        entity:
          domain: light

    adaptive_switch:
      name: Adaptive Lighting switch
      description: The Adaptive Lighting instance that manages these lights (switch.adaptive_lighting_*)
      selector:
        entity:
          domain: switch

    apply_transition:
      name: Adaptive apply transition (seconds)
      description: Small transition helps prevent brief wrong-state flashes on turn-on
      default: 0.1
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: s

    full_white_kelvin:
      name: Full white Kelvin (long press)
      default: 4000
      selector:
        number:
          min: 2700
          max: 6500
          step: 100
          unit_of_measurement: K

mode: restart

trigger:
  - platform: state
    id: button1
    entity_id: !input button1_event
  - platform: state
    id: button2
    entity_id: !input button2_event

# No-flash guard: only act on real state changes, ignore unknown/unavailable
condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  - condition: template
    value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
  - condition: template
    value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"

variables:
  adaptive: !input adaptive_switch
  tr: !input apply_transition
  kelvin: !input full_white_kelvin

  trigger_id: "{{ trigger.id }}"
  press_type: "{{ trigger.to_state.attributes.event_type | default('') }}"

  # Full-white detection thresholds
  full_white_bri_min: 250
  full_white_kelvin_tol: 250

action:
  - choose:

      # ───────── Button 1 Single Press (multi_press_1) ─────────
      - conditions: "{{ trigger_id == 'button1' and press_type == 'multi_press_1' }}"
        sequence:
          - variables:
              L: !input light_a
          - choose:
              - conditions: "{{ is_state(L, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ L }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: false
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  turn_on_lights: true
                  transition: "{{ tr }}"

      # ───────── Button 2 Single Press (multi_press_1) ─────────
      - conditions: "{{ trigger_id == 'button2' and press_type == 'multi_press_1' }}"
        sequence:
          - variables:
              L: !input light_b
          - choose:
              - conditions: "{{ is_state(L, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ L }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: false
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  turn_on_lights: true
                  transition: "{{ tr }}"

      # ───────── Button 1 Long Press (long_press) ─────────
      - conditions: "{{ trigger_id == 'button1' and press_type == 'long_press' }}"
        sequence:
          - variables:
              L: !input light_a
              bri: "{{ state_attr(L, 'brightness') | int(0) }}"
              ct: "{{ state_attr(L, 'color_temp_kelvin') | int(0) }}"
              is_full_white_now: >
                {{ is_state(L,'on')
                   and bri >= full_white_bri_min
                   and ct != 0
                   and ((ct - (kelvin | int)) | abs) <= full_white_kelvin_tol }}
          - choose:
              # If already full white -> return to Adaptive Lighting
              - conditions: "{{ is_full_white_now }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      manual_control: false
                  - service: adaptive_lighting.apply
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      turn_on_lights: true
                      transition: "{{ tr }}"
            default:
              # Otherwise -> force full white and mark manual control
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"
                data:
                  brightness: 255
                  color_temp_kelvin: "{{ kelvin }}"

      # ───────── Button 2 Long Press (long_press) ─────────
      - conditions: "{{ trigger_id == 'button2' and press_type == 'long_press' }}"
        sequence:
          - variables:
              L: !input light_b
              bri: "{{ state_attr(L, 'brightness') | int(0) }}"
              ct: "{{ state_attr(L, 'color_temp_kelvin') | int(0) }}"
              is_full_white_now: >
                {{ is_state(L,'on')
                   and bri >= full_white_bri_min
                   and ct != 0
                   and ((ct - (kelvin | int)) | abs) <= full_white_kelvin_tol }}
          - choose:
              - conditions: "{{ is_full_white_now }}"
                sequence:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      manual_control: false
                  - service: adaptive_lighting.apply
                    data:
                      entity_id: "{{ adaptive }}"
                      lights: ["{{ L }}"]
                      turn_on_lights: true
                      transition: "{{ tr }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive }}"
                  lights: ["{{ L }}"]
                  manual_control: true
              - service: light.turn_on
                target:
                  entity_id: "{{ L }}"
                data:
                  brightness: 255
                  color_temp_kelvin: "{{ kelvin }}"
