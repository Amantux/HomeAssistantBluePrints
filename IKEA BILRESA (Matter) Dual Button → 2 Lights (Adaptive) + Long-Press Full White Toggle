blueprint:
  name: IKEA BILRESA (Matter) Dual Button â†’ Toggle 2 Lights (Adaptive Lighting per-light) + Accurate Hold White/Adaptive Toggle
  description: >
    For IKEA BILRESA 806.178.76 (Matter over Thread). Uses two Matter event entities (one per button).
    Each button controls its own light and its own Adaptive Lighting switch (per-light instance).
    Single press: toggle Light A/B and apply Adaptive Lighting (brightness + color).
    Hold: waits for release; if not released within hold_seconds, toggles between selectable white mode and
    CURRENT Adaptive Lighting settings for that time (for that specific light).
  domain: automation

  input:
    button_a_event:
      name: Button A event entity
      description: Select the Matter event entity for button A (e.g., event.bilresa_button_1)
      selector:
        entity:
          domain: event

    button_b_event:
      name: Button B event entity
      description: Select the Matter event entity for button B (e.g., event.bilresa_button_2)
      selector:
        entity:
          domain: event

    light_a:
      name: Light A (Button A)
      selector:
        entity:
          domain: light

    light_b:
      name: Light B (Button B)
      selector:
        entity:
          domain: light

    adaptive_switch_a:
      name: Adaptive Lighting switch for Light A
      description: Adaptive Lighting switch entity dedicated to Light A (e.g., switch.adaptive_lighting_kitchen)
      selector:
        entity:
          domain: switch

    adaptive_switch_b:
      name: Adaptive Lighting switch for Light B
      description: Adaptive Lighting switch entity dedicated to Light B (e.g., switch.adaptive_lighting_entryway)
      selector:
        entity:
          domain: switch

    hold_seconds:
      name: Hold duration seconds
      default: 3
      selector:
        number:
          min: 1
          max: 10
          step: 1
          mode: slider

    white_temp_kelvin:
      name: White mode color temp (Kelvin)
      default: 3000
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider

    white_brightness_pct:
      name: White mode brightness (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    white_temp_tolerance_kelvin:
      name: White mode tolerance (Kelvin)
      default: 150
      selector:
        number:
          min: 0
          max: 1000
          step: 25
          mode: slider

mode: restart

trigger:
  - platform: state
    entity_id: !input button_a_event
    id: button_a
    not_from:
      - unknown
      - unavailable
  - platform: state
    entity_id: !input button_b_event
    id: button_b
    not_from:
      - unknown
      - unavailable

variables:
  button_a_event: !input button_a_event
  button_b_event: !input button_b_event

  light_a: !input light_a
  light_b: !input light_b

  adaptive_a: !input adaptive_switch_a
  adaptive_b: !input adaptive_switch_b

  hold_seconds: !input hold_seconds
  white_temp_kelvin: !input white_temp_kelvin
  white_brightness_pct: !input white_brightness_pct
  white_temp_tolerance_kelvin: !input white_temp_tolerance_kelvin

  # Common "single press" types
  single_press_types:
    - press
    - pressed
    - short_press
    - short_release
    - single_press
    - multi_press_1

  # Common "hold start" types (varies by firmware/controller)
  hold_start_types:
    - long_press
    - long_press_start
    - hold
    - button_hold
    - held
    - long

  # Common "hold end" / release types (varies by firmware/controller)
  hold_end_types:
    - long_release
    - long_press_end
    - release
    - released
    - button_release
    - hold_release
    - up

  etype: "{{ state_attr(trigger.entity_id, 'event_type') | default('') }}"

action:
  - choose:
      ######################################################################
      # HOLD: Button A -> accurate hold detection -> toggle white/adaptive (Light A)
      ######################################################################
      - conditions:
          - condition: trigger
            id: button_a
          - condition: template
            value_template: "{{ etype in hold_start_types }}"
        sequence:
          - wait_for_trigger:
              - platform: state
                entity_id: !input button_a_event
            timeout:
              seconds: "{{ hold_seconds }}"
            continue_on_timeout: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{
                        wait.trigger is not none
                        and (state_attr(button_a_event, 'event_type') | default('')) in hold_end_types
                      }}
                sequence: []
            default:
              - variables:
                  target_light: "{{ light_a }}"
                  target_adaptive: "{{ adaptive_a }}"
                  cur_ct: "{{ state_attr(target_light, 'color_temp_kelvin') | default(0) | int }}"
                  in_white_mode: >-
                    {{
                      is_state(target_light, 'on')
                      and cur_ct > 0
                      and (cur_ct - (white_temp_kelvin | int)) | abs <= (white_temp_tolerance_kelvin | int)
                    }}
              - choose:
                  - conditions: "{{ in_white_mode }}"
                    sequence:
                      - service: adaptive_lighting.set_manual_control
                        data:
                          entity_id: "{{ target_adaptive }}"
                          lights:
                            - "{{ target_light }}"
                          manual_control: false
                      - service: adaptive_lighting.apply
                        data:
                          entity_id: "{{ target_adaptive }}"
                          lights:
                            - "{{ target_light }}"
                          adapt_brightness: true
                          adapt_color: true
                          transition: 0
                          turn_on_lights: true
                default:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ target_adaptive }}"
                      lights:
                        - "{{ target_light }}"
                      manual_control: true
                  - service: light.turn_on
                    target:
                      entity_id: "{{ target_light }}"
                    data:
                      color_temp_kelvin: "{{ white_temp_kelvin }}"
                      brightness_pct: "{{ white_brightness_pct }}"

      ######################################################################
      # HOLD: Button B -> accurate hold detection -> toggle white/adaptive (Light B)
      ######################################################################
      - conditions:
          - condition: trigger
            id: button_b
          - condition: template
            value_template: "{{ etype in hold_start_types }}"
        sequence:
          - wait_for_trigger:
              - platform: state
                entity_id: !input button_b_event
            timeout:
              seconds: "{{ hold_seconds }}"
            continue_on_timeout: true
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{
                        wait.trigger is not none
                        and (state_attr(button_b_event, 'event_type') | default('')) in hold_end_types
                      }}
                sequence: []
            default:
              - variables:
                  target_light: "{{ light_b }}"
                  target_adaptive: "{{ adaptive_b }}"
                  cur_ct: "{{ state_attr(target_light, 'color_temp_kelvin') | default(0) | int }}"
                  in_white_mode: >-
                    {{
                      is_state(target_light, 'on')
                      and cur_ct > 0
                      and (cur_ct - (white_temp_kelvin | int)) | abs <= (white_temp_tolerance_kelvin | int)
                    }}
              - choose:
                  - conditions: "{{ in_white_mode }}"
                    sequence:
                      - service: adaptive_lighting.set_manual_control
                        data:
                          entity_id: "{{ target_adaptive }}"
                          lights:
                            - "{{ target_light }}"
                          manual_control: false
                      - service: adaptive_lighting.apply
                        data:
                          entity_id: "{{ target_adaptive }}"
                          lights:
                            - "{{ target_light }}"
                          adapt_brightness: true
                          adapt_color: true
                          transition: 0
                          turn_on_lights: true
                default:
                  - service: adaptive_lighting.set_manual_control
                    data:
                      entity_id: "{{ target_adaptive }}"
                      lights:
                        - "{{ target_light }}"
                      manual_control: true
                  - service: light.turn_on
                    target:
                      entity_id: "{{ target_light }}"
                    data:
                      color_temp_kelvin: "{{ white_temp_kelvin }}"
                      brightness_pct: "{{ white_brightness_pct }}"

      ######################################################################
      # SINGLE PRESS: Button A -> toggle Light A (Adaptive on ON)
      ######################################################################
      - conditions:
          - condition: trigger
            id: button_a
          - condition: template
            value_template: "{{ etype in single_press_types or etype == '' }}"
        sequence:
          - choose:
              - conditions: "{{ is_state(light_a, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light_a }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive_a }}"
                  lights:
                    - "{{ light_a }}"
                  manual_control: false
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive_a }}"
                  lights:
                    - "{{ light_a }}"
                  adapt_brightness: true
                  adapt_color: true
                  transition: 0
                  turn_on_lights: true

      ######################################################################
      # SINGLE PRESS: Button B -> toggle Light B (Adaptive on ON)
      ######################################################################
      - conditions:
          - condition: trigger
            id: button_b
          - condition: template
            value_template: "{{ etype in single_press_types or etype == '' }}"
        sequence:
          - choose:
              - conditions: "{{ is_state(light_b, 'on') }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light_b }}"
            default:
              - service: adaptive_lighting.set_manual_control
                data:
                  entity_id: "{{ adaptive_b }}"
                  lights:
                    - "{{ light_b }}"
                  manual_control: false
              - service: adaptive_lighting.apply
                data:
                  entity_id: "{{ adaptive_b }}"
                  lights:
                    - "{{ light_b }}"
                  adapt_brightness: true
                  adapt_color: true
                  transition: 0
                  turn_on_lights: true
