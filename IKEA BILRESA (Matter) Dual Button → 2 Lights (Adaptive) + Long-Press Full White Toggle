blueprint:
  name: IKEA BILRESA (Matter) Dual Button â†’ 2 Lights + Adaptive per Light + Tap Toggle + Long-Hold Release Mode Toggle (No Helpers)
  description: >
    Tap (multi_press_1): toggle light on/off
    Hold (long_press): if held >= threshold, then on release (long_release) toggle mode:
      Adaptive ON -> White mode (Adaptive OFF + force white)
      Adaptive OFF -> Adaptive ON
    If released before threshold: do nothing
    No helpers needed; uses wait_for_trigger to observe release after hold starts.
  domain: automation

  input:
    button1_event:
      name: Button 1 event entity (Matter)
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button

    button2_event:
      name: Button 2 event entity (Matter)
      selector:
        entity:
          filter:
            integration: matter
            domain: event
            device_class: button

    light_1:
      name: Light 1 (Button 1)
      selector:
        entity:
          filter:
            domain: light

    light_2:
      name: Light 2 (Button 2)
      selector:
        entity:
          filter:
            domain: light

    adaptive_switch_1:
      name: Adaptive Lighting switch for Light 1 (recommended)
      default: ""
      selector:
        entity:
          filter:
            domain: switch

    adaptive_switch_2:
      name: Adaptive Lighting switch for Light 2 (recommended)
      default: ""
      selector:
        entity:
          filter:
            domain: switch

    full_white_kelvin:
      name: White mode color temperature (K)
      default: 6500
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider

    full_white_brightness_pct:
      name: White mode brightness (%)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    hold_threshold_1:
      name: Button 1 hold threshold (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider

    hold_threshold_2:
      name: Button 2 hold threshold (seconds)
      default: 0.75
      selector:
        number:
          min: 0.25
          max: 5
          step: 0.25
          mode: slider

mode: restart

trigger:
  - platform: state
    id: b1
    entity_id: !input button1_event
  - platform: state
    id: b2
    entity_id: !input button2_event

condition:
  - condition: template
    value_template: >
      {{ trigger.from_state is not none and trigger.to_state is not none
         and trigger.from_state.state not in ['unknown','unavailable']
         and trigger.to_state.state not in ['unknown','unavailable']
         and trigger.from_state.state != trigger.to_state.state }}

variables:
  # Raw inputs (NO templates here)
  light1: !input light_1
  light2: !input light_2
  adaptive1: !input adaptive_switch_1
  adaptive2: !input adaptive_switch_2
  threshold1: !input hold_threshold_1
  threshold2: !input hold_threshold_2
  kelvin: !input full_white_kelvin
  bright: !input full_white_brightness_pct

  # Derived values (templates allowed)
  press_type: "{{ trigger.to_state.attributes.event_type }}"
  is_b1: "{{ trigger.id == 'b1' }}"
  event_entity: "{{ trigger.entity_id }}"
  target_light: "{{ light1 if is_b1 else light2 }}"
  target_adaptive: "{{ adaptive1 if is_b1 else adaptive2 }}"
  hold_threshold: "{{ threshold1 if is_b1 else threshold2 }}"

action:
  - choose:
      # Tap -> toggle on/off
      - conditions:
          - condition: template
            value_template: "{{ press_type == 'multi_press_1' }}"
        sequence:
          - action: light.toggle
            target:
              entity_id: "{{ target_light }}"

      # Hold start -> only act if held >= threshold; then toggle mode on release
      - conditions:
          - condition: template
            value_template: "{{ press_type == 'long_press' }}"
        sequence:
          # If release happens BEFORE threshold, it's a short hold -> do nothing.
          - wait_for_trigger:
              - platform: state
                entity_id: "{{ event_entity }}"
            timeout:
              seconds: "{{ hold_threshold }}"
            continue_on_timeout: true

          # If we timed out => long hold. Now wait for actual release.
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not wait.completed }}"
                sequence:
                  - wait_for_trigger:
                      - platform: state
                        entity_id: "{{ event_entity }}"
                    timeout:
                      minutes: 10
                    continue_on_timeout: false

                  - condition: template
                    value_template: "{{ wait.trigger.to_state.attributes.event_type == 'long_release' }}"

                  - condition: template
                    value_template: "{{ is_state(target_light, 'on') }}"

                  - choose:
                      # Adaptive ON -> White mode
                      - conditions:
                          - condition: template
                            value_template: "{{ target_adaptive != '' and is_state(target_adaptive, 'on') }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: "{{ target_adaptive }}"
                          - action: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: "{{ bright }}"
                              color_temp_kelvin: "{{ kelvin }}"

                      # Adaptive OFF -> Adaptive ON
                      - conditions:
                          - condition: template
                            value_template: "{{ target_adaptive != '' and is_state(target_adaptive, 'off') }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: "{{ target_adaptive }}"
                          - delay:
                              milliseconds: 150
                          - action: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data: {}
                    default:
                      # No adaptive switch configured: best-effort white only
                      - action: light.turn_on
                        target:
                          entity_id: "{{ target_light }}"
                        data:
                          brightness_pct: "{{ bright }}"
                          color_temp_kelvin: "{{ kelvin }}"
            default: []
    default: []
